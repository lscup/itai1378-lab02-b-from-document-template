name: Autograding Tests

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jupyter nbconvert pytest

    - name: testimportlibraries
      id: testimportlibraries
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: "Test Import Libraries"
        setup-command: python -c "import cv2; import numpy as np; from matplotlib import pyplot as plt; import ipywidgets as widgets; from IPython.display import display"
        command: jupyter nbconvert --to notebook --execute notebook.ipynb --stdout
        timeout: 10
        max-score: 10

    - name: testshowimagesfunction
      id: testshowimagesfunction
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: "Test Show Images Function"
        setup-command: python -c "import numpy as np; import cv2; img = np.ones((100, 100, 3), dtype=np.uint8) * 255; cv2.imwrite('test_image.png', img); np.save('original_rgb.npy', cv2.cvtColor(img, cv2.COLOR_BGR2RGB))"
        command: jupyter nbconvert --to notebook --execute notebook.ipynb --stdout
        timeout: 10
        max-score: 20

    - name: testshowhistogramfunction
      id: testshowhistogramfunction
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: "Test Show Histogram Function"
        setup-command: python -c "import numpy as np; import cv2; img = np.ones((100, 100, 3), dtype=np.uint8) * 255; np.save('processed_rgb.npy', cv2.cvtColor(img, cv2.COLOR_BGR2RGB))"
        command: jupyter nbconvert --to notebook --execute notebook.ipynb --stdout
        timeout: 10
        max-score: 20

    - name: testbrowseimagecallback
      id: testbrowseimagecallback
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: "Test Browse Image Callback"
        setup-command: python -c "import cv2; import numpy as np; test_img = np.ones((100, 100, 3), dtype=np.uint8) * 255; cv2.imwrite('image.png', test_img)"
        command: jupyter nbconvert --to notebook --execute notebook.ipynb --stdout
        timeout: 10
        max-score: 20

    - name: testgrayscaleconversioncallback
      id: testgrayscaleconversioncallback
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: "Test Grayscale Conversion Callback"
        setup-command: python -c "import cv2; import numpy as np; test_img = np.ones((100, 100, 3), dtype=np.uint8) * 255; cv2.imwrite('image.png', test_img)"
        command: jupyter nbconvert --to notebook --execute notebook.ipynb --stdout
        timeout: 10
        max-score: 15

    - name: testbrightnesschangecallback
      id: testbrightnesschangecallback
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: "Test Brightness Change Callback"
        setup-command: python -c "import cv2; import numpy as np; test_img = np.ones((100, 100, 3), dtype=np.uint8) * 255; cv2.imwrite('image.png', test_img)"
        command: jupyter nbconvert --to notebook --execute notebook.ipynb --stdout
        timeout: 10
        max-score: 15

    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        TESTIMPORTLIBRARIES_RESULTS: "${{steps.testimportlibraries.outputs.result}}"
        TESTSHOWIMAGESFUNCTION_RESULTS: "${{steps.testshowimagesfunction.outputs.result}}"
        TESTSHOWHISTOGRAMFUNCTION_RESULTS: "${{steps.testshowhistogramfunction.outputs.result}}"
        TESTBROWSEIMAGECALLBACK_RESULTS: "${{steps.testbrowseimagecallback.outputs.result}}"
        TESTGRAYSCALECONVERSIONCALLBACK_RESULTS: "${{steps.testgrayscaleconversioncallback.outputs.result}}"
        TESTBRIGHTNESSCHANGECALLBACK_RESULTS: "${{steps.testbrightnesschangecallback.outputs.result}}"
      with:
        runners: testimportlibraries,testshowimagesfunction,testshowhistogramfunction,testbrowseimagecallback,testgrayscaleconversioncallback,testbrightnesschangecallback
